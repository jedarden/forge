# ADR 0016: Onboarding Flow and CLI Worker Detection

## Status

Accepted

## Context

FORGE currently requires manual setup:
- Users must manually create `~/.forge/config.yaml`
- Launcher scripts must be written by hand
- No first-run experience or setup wizard
- No automatic detection of available AI CLI tools

This creates friction for new users and makes FORGE harder to adopt. Users need to:
1. Read documentation to understand configuration format
2. Manually configure chat backend (claude-code, opencode, etc.)
3. Write launcher scripts for worker spawning
4. Set up directory structure and permissions

The README mentions `forge init` but it's not implemented.

## Problem

**New User Experience Gap:**
- No guided setup process
- High barrier to entry (requires manual YAML editing)
- No validation of configuration
- No auto-discovery of installed CLI tools

**Specific Issues:**
1. Users don't know if they have compatible CLI tools installed
2. Configuration is error-prone (typos, wrong paths, missing fields)
3. No feedback if setup is incorrect until runtime
4. Difficult to switch between different CLI backends

## Decision

### Implement First-Run Onboarding Flow

When forge starts and detects missing or incomplete configuration, it will:

1. **Detect CLI Tools**
   - Scan `$PATH` for compatible headless CLI tools
   - Check for: `claude` (Claude Code), `opencode`, `aider`
   - Verify each tool supports required flags (`--output-format`, `--dangerously-skip-permissions`, etc.)

2. **Interactive Setup (TUI Mode)**
   - Show detected CLI tools with status indicators
   - Let user select which tool to use as chat backend
   - Auto-generate launcher scripts for selected tool
   - Validate API keys in environment (if needed)
   - Create default `config.yaml`

3. **Non-Interactive Setup (Headless Mode)**
   - Environment variable: `FORGE_CHAT_BACKEND=claude|opencode|aider`
   - Auto-select first available CLI tool if not specified
   - Generate minimal working config
   - Exit with error if no compatible tools found

4. **Configuration Generation**
   - Create `~/.forge/` directory structure
   - Generate `config.yaml` with detected settings
   - Create launcher scripts in `~/.forge/launchers/`
   - Set executable permissions
   - Create `.gitignore` for sensitive files

### CLI Tool Detection Protocol

For each potential CLI tool:

```rust
struct CliToolDetection {
    name: String,              // "claude-code", "opencode", etc.
    binary_path: PathBuf,      // Full path to executable
    version: Option<String>,   // Tool version if detectable
    headless_support: bool,    // Supports --output-format stream-json
    skip_permissions: bool,    // Supports --dangerously-skip-permissions
    api_key_required: bool,    // Needs API key in environment
    api_key_detected: bool,    // API key found in env
}
```

**Detection Steps:**
1. Search `$PATH` for known binary names
2. Run `<binary> --version` to confirm it's executable
3. Test for headless flags: `<binary> --help | grep "output-format"`
4. Check environment for required API keys

### Onboarding UI Flow

```
┌─ FORGE First Run Setup ─────────────────────────────┐
│                                                      │
│  Detected CLI Tools:                                 │
│                                                      │
│  ✅ Claude Code (v1.2.3) - /usr/local/bin/claude    │
│     API Key: ✅ Found (ANTHROPIC_API_KEY)           │
│                                                      │
│  ❌ OpenCode - Not found                            │
│                                                      │
│  ⚠️  Aider (v0.35.0) - /usr/local/bin/aider         │
│     API Key: ❌ Missing (OPENAI_API_KEY)            │
│                                                      │
│  Select chat backend: [Claude Code (Recommended)]   │
│                                                      │
│  [ Continue ]  [ Manual Setup ]  [ Quit ]           │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### Generated Configuration

**config.yaml (auto-generated):**
```yaml
# Auto-generated by forge init
# Last updated: 2026-02-10

chat_backend:
  command: claude
  args:
    - --dangerously-skip-permissions
    - --output-format
    - stream-json
  model: sonnet
  timeout: 30
  max_retries: 3

launchers:
  claude-code:
    executable: ~/.forge/launchers/claude-code-launcher
    models: [sonnet, opus, haiku]

# ... rest of config ...
```

**Launcher script (auto-generated):**
```bash
#!/usr/bin/env bash
# Auto-generated by forge init
# CLI Backend: Claude Code

set -euo pipefail

MODEL="${1:-sonnet}"
WORKSPACE="${2:-$PWD}"
SESSION_NAME="${3:-worker-$$}"

# Auto-detected: /usr/local/bin/claude
exec claude \
  --model="$MODEL" \
  --dangerously-skip-permissions \
  --output-format stream-json \
  "$@"
```

### Configuration Validation

After setup, forge will:
1. Test chat backend by sending a simple message
2. Verify launcher script is executable
3. Check all required directories exist
4. Validate YAML syntax
5. Show validation results to user

### Upgrade Path for Existing Users

Users who already have `~/.forge/config.yaml`:
- **No disruption** - onboarding is skipped
- **Optional re-detection**: `forge init --reconfigure`
- **Add missing tools**: `forge init --detect-tools`
- **Validate config**: `forge validate`

## Consequences

### Positive

1. **Lower barrier to entry** - New users can start forge in minutes
2. **Fewer support issues** - Automated setup reduces configuration errors
3. **Better discovery** - Users learn what CLI tools are available
4. **Graceful degradation** - Works without configuration in read-only mode
5. **Self-documenting** - Generated config includes helpful comments

### Negative

1. **Maintenance burden** - Need to keep detection logic updated for new CLI tools
2. **Platform differences** - PATH handling differs on Windows/Linux/macOS
3. **Permission issues** - Automatic script creation may fail in restricted environments
4. **False positives** - May detect incompatible tools with similar names

### Neutral

1. **Not required** - Power users can still manually configure
2. **Extendable** - Can add more CLI tools as they become popular
3. **Config migration** - Future versions may need migration logic

## Implementation Notes

### File Structure

```
crates/
  forge-init/              # NEW: Onboarding logic
    src/
      detection.rs         # CLI tool detection
      wizard.rs            # TUI setup wizard
      generator.rs         # Config generation
      validator.rs         # Config validation
    tests/
      detection_tests.rs
      integration_tests.rs
```

### CLI Commands

```bash
# First run (auto-triggers if no config)
forge

# Force re-run setup
forge init

# Non-interactive mode
FORGE_CHAT_BACKEND=claude forge init --non-interactive

# Validate existing config
forge validate

# Detect available tools
forge detect-tools
```

### Testing Strategy

1. **Unit tests**: Mock `which` command results
2. **Integration tests**: Test config generation
3. **Platform tests**: Run on Linux, macOS, Windows
4. **Regression tests**: Ensure existing configs still work

## Related

- ADR 0005: Dumb Orchestrator Architecture (launcher protocol)
- ADR 0006: Technology Stack Selection (TUI framework)
- ADR 0015: Bead-Aware Launcher Protocol (launcher arguments)

## References

- [Claude Code documentation](https://github.com/anthropics/claude-code)
- [Aider setup guide](https://aider.chat/docs/install.html)
- [OpenCode project](https://github.com/OpenCodeDev)
